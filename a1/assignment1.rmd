---
title: "Linear Models, Assignment 1: Electricity consumption"
author: "Cristian Del Toro, Arpon Kundu"
date: "February 21, 2025"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **Conclusions:** 

- Linear models were trained and tested using the airquality dataset, with Ozone as the response variable and Wind, Temp, and Solar.R as predictors.
- The most relevant feature is a very uncommon transformation, Wind^(-1), which highlights the importance of plotting variables to get an idea of possible relationships.
- The ANOVA tests show that using Interactions + Quadratic features results in a supperior fit than just the original features or just the interaction features.
- From the Residual plots and Shepiro test it can be concluded that the residuals deviate significantly from normality, which violates linear regression assumptions. 
- The VIF test showed high Multicollinearity  issues. The AIC criterion was used used to select the most relevant features. The difference in performance is not significant according to the following ANOVA test. 
- The Durbin-Watson test showed mild positive autocorrelation in the residuals.
- Using GLM didn't change the results from the Durbin-Watson test or the model performance.

```{r load_data}
options(repos = c(CRAN = "https://cloud.r-project.org"))

library(MASS)
library(ISLR2)
library(car)
library(nlme)
library(lmtest)

data_weather <- read.csv("consumption_20240208.csv", header = TRUE, sep = ",", fileEncoding = "latin1")
data_weather
```

Q1: We will use mean temperature.

## Plots
```{r plots, echo=FALSE}
data_weather_numeric <- data_weather[, sapply(data_weather, is.numeric)]
pairs(data_weather_numeric)
cor(data_weather_numeric, use = "complete.obs")
summary(data_weather)
```

## Data
```{r}
lm.fit <- lm(Net.Consumption~Mean.Temp, data=data_weather)
summary(lm.fit)
names(lm.fit)
coef(lm.fit)
confint(lm.fit)
```

Q2: On average, the consumption energy decrease when outside temperature increases.   

## Predictions 
```{r predictions_given_points}
# Predict for new values
new_data <- data.frame(Mean.Temp = c(-40, -20, 0, 20, 40))
# Get predictions
predictions <- predict(lm.fit, newdata = new_data)
# Combine Mean.Temp and Predictions into a single dataframe
results <- data.frame(Mean.Temp = new_data$Mean.Temp, Prediction = predictions)
# Print the results
print(results)
```

```{r plot_predictions}
# Load ggplot2 if not already installed
install.packages("ggplot2")
library(ggplot2)

# Create scatter plot with regression line
ggplot(data_weather, aes(x = Mean.Temp, y = Net.Consumption)) + 
  geom_point(color = "blue") +  # Scatter plot points
  geom_smooth(method = "lm", color = "red", se = FALSE) +  # Regression line
  labs(title = "Scatter Plot with Regression Line",
       x = "Mean Temperature",
       y = "Response Variable") +
  theme_minimal()

```
Q4: The estimates for 0C and 20C seem reasonable because the line is close to the average consuption for those temperature ranges. We are unsatisfied with the predictions for all other temperatures (-40C, -20C and 40C) which seem to be under estimations. 

## Interaction Terms
```{r interaction_terms}
lm.fit2 <- lm(Ozone ~ Wind*Temp + Wind*Solar.R + Temp*Solar.R, data = airquality)
summary(lm.fit2)
```

## Non-linear Transformations of the Predictors
```{r non_linear_transformations}
lm.fit3 <- lm(Ozone ~ I(Temp^2) + I(Wind^-1)+Wind*Temp + Wind*Solar.R + Temp*Solar.R, data = airquality)
summary(lm.fit3)

lm.fit4 <- lm(Ozone ~ I(Temp^2) + I(Temp^3) + I(Temp^4) + I(Wind^-1)+I(Wind^-2)+Wind*Temp + Wind*Solar.R + Temp*Solar.R, data = airquality)
summary(lm.fit4)
```

## Model Comparison
```{r model_comparison}
anova(lm.fit, lm.fit4)
anova(lm.fit2, lm.fit4)
anova(lm.fit3, lm.fit4)
```

## Residual Plots & Q-Plots
```{r par_plots}
par(mfrow = c(2, 2))
plot(lm.fit4)
```

## Statistical Tests 
```{r statistical_tests}
shapiro.test(residuals(lm.fit4)) 
alias(lm.fit4)
durbinWatsonTest(lm.fit4)
vif(lm.fit4) 
```

## Model Reduction
```{r model_reduction}
library(MASS)
lm.fit5 <- stepAIC(lm.fit4, direction = "both")
summary(lm.fit5)

durbinWatsonTest(lm.fit5)
vif(lm.fit5)
anova(lm.fit4, lm.fit5)
```

```{r generalized_least_squared}
airquality_clean <- na.omit(airquality)
glm_model.fit <- glm(Ozone ~ I(Temp^2) + I(Temp^3) + I(Temp^4) + I(Wind^-1)+I(Wind^-2)+Wind*Temp + Wind*Solar.R + Temp*Solar.R, data = airquality_clean)
glm_model.fit2 <- stepAIC(glm_model.fit, direction="both")

summary(glm_model.fit2)
R2_gls <- 1 - (var(residuals(glm_model.fit2)) / var(airquality_clean$Ozone, na.rm = TRUE))
cat("R square:", R2_gls)

durbinWatsonTest(glm_model.fit2)

par(mfrow = c(2, 2))
plot(glm_model.fit2)
```


